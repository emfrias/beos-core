stages:
  - staging-build
  - development-build
  - staging-deploy
#  - plugin-test

staging-build:
  stage: staging-build
  variables:
    LC_ALL: "C"
    CI_BEOS_CONFIG_NAME: "ci"
    GIT_SUBMODULE_STRATEGY: recursive
    
  script:
    - chmod +x ./gitlab-ci/build.sh
    - ./gitlab-ci/build.sh
    - chmod +x ./gitlab-ci/test.sh
    - ./gitlab-ci/test.sh
    - echo "Started keosd instance (should be empty):"
    - lsof -t -i:8900 || true
    - echo "Started nodeos instance (should be empty):"
    - lsof -t -i:8888 || true
    - screen -list || true

  cache: {}
  tags:
    - ryzen
  allow_failure: false
  only:
   - beos-initial-release

development-build:
  stage: development-build
  variables:
    LC_ALL: "C"
    CI_BEOS_CONFIG_NAME: "ci"
    GIT_SUBMODULE_STRATEGY: recursive
    
  script:
    - chmod +x ./gitlab-ci/build.sh
    - ./gitlab-ci/build.sh
    - chmod +x ./gitlab-ci/test.sh
    - ./gitlab-ci/test.sh
    - echo "Started keosd instance (should be empty):"
    - lsof -t -i:8900 || true
    - echo "Started nodeos instance (should be empty):"
    - lsof -t -i:8888 || true
    - screen -list || true

  cache: {}
  tags:
    - ryzen
  allow_failure: false
  when: manual
  except:
   - beos-initial-release

staging-deploy:
  stage: staging-deploy
  variables:
    LC_ALL: "C"
    CI_BEOS_CONFIG_NAME: "allcpu"
    GIT_SUBMODULE_STRATEGY: recursive
    
  script:
    - chmod +x ./gitlab-ci/build.sh
    - ./gitlab-ci/build.sh
    - chmod +x ./gitlab-ci/run.sh
    - ./gitlab-ci/run.sh

  cache: {}
  tags:
    - allcpu
  allow_failure: false
  when: manual
  only:
    - beos-initial-release
  environment:
    name: staging
    url: http://192.168.6.242:8888/v1/chain/get_info

# currently disabled and not fully configured
# plugin-test:
#   stage: plugin-test
#   script:
#   - pwd
#   - ./deploy.py --make-beos-plugin-test
#   when: manual
#   cache: {}
#   tags:
#   - ryzen
#   allow_failure: true
